with highest_level_components as (
    SELECT DISTINCT csd1.ancestor_concept_id concept_id, csd1.ancestor_concept_name concept_name
    FROM `{{pdr_project}}.{{curation_dataset}}.measurement_concept_sets_descendants` csd1
    LEFT JOIN `{{pdr_project}}.{{curation_dataset}}.measurement_concept_sets_descendants` csd2
    ON csd1.ancestor_concept_id = csd2.descendant_concept_id
    WHERE csd2.ancestor_concept_id IS NULL
),
hpo_list as (
    SELECT
        LOWER(hpo.HPO_ID) hpo_id
    FROM `{{pdr_project}}.{{curation_dataset}}.v_org_hpo_mapping` hpo
),
recommended_codes as (
    select
        *
    from
        unnest(
            [
"14647-2",
"2093-3",
"14646-4",
"2085-9",
"26015-8",
"26017-4",
"49130-8",
"9832-7",
"9833-5",
"13457-7",
"18262-6",
"2089-1",
"22748-8",
"39469-2",
"49132-4",
"55440-2",
"69419-0",
"13458-5",
"2091-7",
"25371-6",
"49133-2",
"66126-4",
"12951-0",
"14927-8",
"1644-4",
"2571-8",
"3043-7",
"3048-6",
"30524-3",
"47210-0",
"70218-3",
"2947-0",
"2951-2",
"12812-4",
"12813-2",
"2823-3",
"6298-4",
"75940-7",
"2069-3",
"2075-0",
"1959-6",
"1963-8",
"14937-7",
"3094-0",
"59570-2",
"6299-2",
"14682-9",
"2160-0",
"38483-4",
"59826-8",
"14749-6",
"15074-8",
"2339-0",
"2340-8",
"2341-6",
"2345-7",
"72516-8",
"26464-8",
"49498-9",
"6690-2",
"804-5",
"26453-1",
"789-8",
"790-6",
"20509-6",
"55782-7",
"59260-0",
"718-7",
"20570-8",
"31100-1",
"4544-3",
"4545-0",
"48703-3",
"26515-7",
"49497-1",
"777-3",
"778-1",
"14631-6",
"1975-2",
"42719-5",
"54363-7",
"14629-0",
"15152-2",
"1968-7",
"29760-6",
"1751-7",
"2862-1",
"54347-0",
"61151-7",
"61152-5",
"62234-0",
"62235-7",
"76631-1",
"2885-2",
"1783-0",
"6768-6",
"1920-8",
"30239-8",
"88112-8",
"1742-6",
"1743-4",
"1744-2",
"76625-3",
"2324-2",
"2756-5",
"50560-2",
"5803-2",
"15076-3",
"22705-8",
"2350-7",
"53328-1",
"5792-7",
"59156-0",
"2888-6",
"50561-0",
"5804-0",
"1978-6",
"20505-4",
"41016-7",
"53327-3",
"68367-2",
"70199-5",
"20405-7",
"3107-0",
"34927-4",
"34928-2",
"50563-6",
"60025-4",
"22702-5",
"49779-2",
"50557-8",
"5797-6",
"59158-6",
"20407-3",
"2657-5",
"20408-1",
"24122-4",
"30405-5",
"51487-7",
"58805-3",
"2349-9",
"25428-4",
"50555-2",
"20454-5",
"2887-8",
"53525-2",
"57735-3",
"1977-8",
"50551-1",
"5770-3",
"58450-8",
"13658-0",
"5818-0",
"62487-4",
"53963-5",
"2514-8",
"33903-6",
"57734-6",
"32710-6",
"50558-6",
"5802-4",
"33052-2",
"53316-6",
"53964-3",
"32167-9",
"50552-9",
"50553-7",
"5778-6",
"2106-3",
"2112-1",
"80384-1",
"2880-3",
"76665-9",
"76666-7",
"76667-5",
"76668-3",
"14744-7",
"2342-4",
"76669-1",
"76670-9",
"76671-7",
"76672-5",
"1746-7",
"2861-3",
"76480-3",
"2520-5",
"27941-4",
"60023-9",
"60024-7",
"26465-5",
"46088-1",
"46089-9",
"46090-7",
"48034-3",
"76674-1",
"805-2",
"806-0",
"26454-9",
"46087-3",
"46091-5",
"46092-3",
"76673-3",
"791-4",
"792-2",
"2464-6",
"76489-4",
"2471-1",
"2457-0",
"11272-2",
"30428-7",
"47282-9",
"62242-3",
"787-2",
"28539-5",
"47278-7",
"62243-1",
"785-6",
"28540-3",
"47279-5",
"62246-4",
"786-4",
"21000-5",
"30384-2",
"30385-9",
"47277-9",
"62247-2",
"788-0",
"23761-0",
"26511-6",
"770-8",
"26478-8",
"30365-1",
"736-9",
"737-7",
"26485-3",
"5905-5",
"744-3",
"26450-7",
"713-8",
"714-6",
"26450-7",
"713-8",
"714-6",
"26499-4",
"66139-7",
"74398-9",
"751-8",
"753-4",
"26474-7",
"30364-4",
"66140-5",
"731-0",
"732-8",
"74401-1",
"26484-6",
"66143-9",
"742-7",
"743-5",
"74399-7",
"26449-9",
"66141-3",
"711-2",
"712-0",
"74404-5",
"26444-0",
"66142-1",
"704-7",
"705-4",
"74406-0",
"8308-9",
"8303-0",
"91370-7",
"8302-2",
"8307-1",
"92999-2",
"8306-3",
"8301-4",
"3138-5",
"8305-5",
"89269-5",
"3137-7",
"56092-0",
"8347-7",
"75292-3",
"8335-2",
"8339-4",
"79348-9",
"8338-6",
"89087-1",
"57067-1",
"8346-9",
"8345-1",
"69461-2",
"56093-8",
"3142-7",
"11753-1",
"11759-8",
"8343-6",
"11741-6",
"33143-9",
"11730-9",
"11746-5",
"33139-7",
"3141-9",
"11755-6",
"11745-7",
"11757-2",
"11749-9",
"11739-0",
"11751-5",
"11747-3",
"11756-4",
"11727-5",
"8341-0",
"11758-0",
"33140-5",
"11760-6",
"11763-0",
"11754-9",
"33162-9",
"11737-4",
"11744-0",
"8336-0",
"8351-9",
"8349-3",
"8344-4",
"8350-1",
"56056-5",
"58229-6",
"69460-4",
"8348-5",
"73965-6",
"11738-2",
"11734-1",
"11752-3",
"11740-8",
"11762-2",
"11736-6",
"8340-2",
"33142-1",
"11765-5",
"11764-8",
"33144-7",
"33141-3",
"33163-7",
"11742-4",
"11729-1",
"11735-8",
"11728-3",
"11733-3",
"8342-8",
"11731-7",
"11750-7",
"11743-2",
"11761-4",
"29463-7",
"11748-1",
"11732-5",
"11125-2",
"10466-1",
"1863-0",
"73576-1",
"73577-9",
"73578-7",
"73579-5",
"73580-3",
"73581-1",
"73582-9",
"77341-6",
"18225-3",
"76476-1",
"8889-8",
"8892-2",
"8890-6",
"8891-4",
"8893-0",
"1996-8",
"2000-8",
"17861-6",
"49765-1",
"27182-5",
"15154-8",
"44017-2",
"30376-8",
"708-8",
"11557-6",
"20565-8",
"34728-6",
"61012-1",
"76170-0",
"76171-8",
"76172-6",
"76173-4",
"76174-2",
"76270-8",
"9279-1",
"11156-7",
"8310-5"]
        ) as code
),
recommended_concept_ids as (
    select
        hlc.concept_id ancestor_concept_id, hlc.concept_name ancestor_concept_name,
        c.concept_id descendant_concept_id
    from
        `{{pdr_project}}.{{curation_dataset}}.concept` c
    JOIN `{{pdr_project}}.{{curation_dataset}}.measurement_concept_sets_descendants` csd
        ON csd.descendant_concept_id = c.concept_id
    JOIN highest_level_components hlc
        ON hlc.concept_id = csd.ancestor_concept_id
    where
        concept_code in (
            select
                code
            from
                recommended_codes
        )
),
wide_net as (
    SELECT DISTINCT
        hlc.concept_id ancestor_concept_id, csd.descendant_concept_id,
        hlc.concept_name ancestor_concept_name
    FROM highest_level_components hlc
    JOIN `{{pdr_project}}.{{curation_dataset}}.measurement_concept_sets_descendants` csd
        ON csd.ancestor_concept_id = hlc.concept_id
    JOIN `{{pdr_project}}.{{curation_dataset}}.concept` c
        ON c.concept_id = csd.descendant_concept_id 
    WHERE c.vocabulary_id = 'LOINC'
        AND c.concept_class_id IN ('Lab Test', 'Clinical Observation')
        AND hlc.concept_id IN (SELECT ancestor_concept_id FROM recommended_concept_ids)
),
recommended_measurement_counts as (
    select
        mm.src_hpo_id, rci.ancestor_concept_id, rci.ancestor_concept_name,
        count(distinct m.measurement_id) as measurement_recommended
    from
        `{{pdr_project}}.{{curation_dataset}}.unioned_ehr_measurement` m
        join `{{pdr_project}}.{{curation_dataset}}._mapping_measurement` mm on m.measurement_id = mm.measurement_id
        join recommended_concept_ids rci on rci.descendant_concept_id = m.measurement_concept_id
    where
        m.measurement_concept_id in (
            select
                descendant_concept_id
            from
                recommended_concept_ids
        )
    group by
        1, 2, 3
),
wide_measurement_counts as (
    select
        mm.src_hpo_id, wn.ancestor_concept_id, wn.ancestor_concept_name,
        count(distinct m.measurement_id) as measurement_wide
    from
        `{{pdr_project}}.{{curation_dataset}}.unioned_ehr_measurement` m
        join `{{pdr_project}}.{{curation_dataset}}._mapping_measurement` mm on m.measurement_id = mm.measurement_id
        join wide_net wn on wn.descendant_concept_id = m.measurement_concept_id
    where
        m.measurement_concept_id in (
            select
                descendant_concept_id
            from
                wide_net
        )
    group by
        1, 2, 3
)
select
    hpo.hpo_id src_hpo_id, hlc.concept_id ancestor_concept_id, hlc.concept_name
    ancestor_concept_name,
    IFNULL(measurement_wide, 0) measurement_wide,
    IFNULL(measurement_recommended, 0) measurement_recommended
from hpo_list hpo
cross join highest_level_components hlc
left join wide_measurement_counts wmc 
    on wmc.src_hpo_id = hpo.hpo_id
        and wmc.ancestor_concept_id = hlc.concept_id
left join recommended_measurement_counts r
    on r.src_hpo_id = hpo.hpo_id
        and r.ancestor_concept_id = hlc.concept_id
WHERE hlc.concept_id IN (SELECT ancestor_concept_id FROM recommended_concept_ids)